# For my final in NRS 568 I wanted to create a user friendly toolbox in python that used 3 tools.
# This toolbox will contain three (3) tools, including a List feature tool, a 5-meter Buffer tool, and an NDVI Calculator.
# Example data to practice with is provided in the accompanying .zip file.

import arcpy

class Toolbox(object):
    def __init__(self):
        """Define the toolbox (the name of the toolbox is the name of the .pyt file)."""
        self.label = "BarthaFinalToolbox" # What the toolbox will be called in ArcMap
        self.alias = ""
        self.tools = [ListFeatures, Buffer5meters, Produce_NDVI]  # List of tool classes associated with this toolbox


class ListFeatures(object):
    def __init__(self):
        """Define the tool (tool name is the name of the class)."""
        self.label = "List Feature class Tool" # What the tool will be called in ArcMap
        self.description = "This tool will search a desired folder and list all raster files of a specified type."
        self.canRunInBackground = False

    def getParameterInfo(self):
        """Define parameter definitions"""
        parameters = []
        input_line = arcpy.Parameter(name="input_line", # Variable name
                                     displayName="Enter the folder you want to search:", # Text that will be displayed in GUI
                                     datatype="DEFolder", # Type of data that can be inputted/outputted
                                     parameterType="Required", # Required|Optional|Derived
                                     direction="Input") # Input|Output
        parameters.append(input_line)
        feature_type = arcpy.Parameter(name="feature_type", # Variable name
                                    displayName="Enter the feature class to display:", # Text that will be displayed in GUI
                                    datatype="GPString",  # Type of data that can be inputted/outputted
                                    parameterType="Required",  # Required|Optional|Derived
                                    direction="Input") # Input|Output
        parameters.append(feature_type)
        return parameters

    def isLicensed(self):
        """Set whether tool is licensed to execute."""
        return True

    def updateParameters(self, parameters):
        """Modify the values and properties of parameters before internal
        validation is performed.  This method is called whenever a parameter
        has been changed."""
        return

    def updateMessages(self, parameters):
        """Modify the messages created by internal validation for each tool
        parameter.  This method is called after internal validation."""
        return

    def execute(self, parameters, messages):
        """The source code of the tool."""
        input_line = parameters[0].valueAsText
        feature_type = parameters[1].valueAsText

        arcpy.env.workspace = input_line
        featureList = arcpy.ListFeatureClasses("*", feature_type)
        featureList = [x for x in featureList if "_BQA.tif" not in x]
        arcpy.AddMessage("The " + feature_type + " are " + str(featureList) + ".")
        arcpy.AddMessage("The number of " + feature_type + " kinds are " + str(len(featureList)) + ".")
        return


class Buffer5meters(object):
    def __init__(self):
        """Define the tool (tool name is the name of the class)."""
        self.label = "Buffer 5-meters Tool" # What the tool will be called in ArcMap
        self.description = "This tool will take up to three feature class objects and apply a 5-meter buffer."
        self.canRunInBackground = False

    def getParameterInfo(self):
        """Define parameter definitions"""
        parameters = []
        shp1 = arcpy.Parameter(name="shp1",
                               displayName="Enter your first shapefile:",
                               datatype="DEFeatureClass",
                               parameterType="Required",
                               direction="Input")
        parameters.append(shp1)
        shp1_output = arcpy.Parameter(name="shp1_output",
                                      displayName="Enter the output destination for the first buffered shapefile:",
                                      datatype="DEFeatureClass",
                                      parameterType="Required",
                                      direction="Output")
        parameters.append(shp1_output)
        return parameters

    def isLicensed(self):
        """Set whether tool is licensed to execute."""
        return True

    def updateParameters(self, parameters):
        """Modify the values and properties of parameters before internal
        validation is performed.  This method is called whenever a parameter
        has been changed."""
        return

    def updateMessages(self, parameters):
        """Modify the messages created by internal validation for each tool
        parameter.  This method is called after internal validation."""
        return

    def execute(self, parameters, messages):
        """The source code of the tool."""
        shp1 = parameters[0].valueAsText
        shp1_output = parameters[1].valueAsText


        inputFeatures = shp1
        outputFeatures = shp1_output
        distance = "5 meters"
        sideType = "FULL"
        lineEndType = "ROUND"
        dissolveOption = "NONE"
        dissolveField = "#"
        method = "PLANAR"
        arcpy.Buffer_analysis(inputFeatures, outputFeatures, distance, sideType,
                              lineEndType, dissolveOption, dissolveField, method)

        arcpy.AddMessage("Buffering of files completed!")
        return


class Produce_NDVI(object):
    def __init__(self):
        """Define the tool (tool name is the name of the class)."""
        self.label = "NDVI Calculation Tool" # What the tool will be called in ArcMap
        self.description = "This tool will take in two .TIF bands and produce an NDVI output from them."
        self.canRunInBackground = False

    def getParameterInfo(self):
        """Define parameter definitions"""
        parameters = []
        band_4 = arcpy.Parameter(name="band_4",
                                 displayName="Enter location for red band:",
                                 datatype="GPRasterLayer",
                                 parameterType="Required",
                                 direction="Input")
        parameters.append(band_4)
        band_5 = arcpy.Parameter(name="band_5",
                                 displayName="Enter location for near infrared band:",
                                 datatype="GPRasterLayer",
                                 parameterType="Required",
                                 direction="Input")
        parameters.append(band_5)
        ndvi_output = arcpy.Parameter(name="ndvi_output",
                                      displayName="Enter a destination for the NDVI output:",
                                      datatype="GPRasterLayer",
                                      parameterType="Required",
                                      direction="Output")
        parameters.append(ndvi_output)
        return parameters

    def isLicensed(self):
        """Set whether tool is licensed to execute."""
        return True

    def updateParameters(self, parameters):
        """Modify the values and properties of parameters before internal
        validation is performed.  This method is called whenever a parameter
        has been changed."""
        return

    def updateMessages(self, parameters):
        """Modify the messages created by internal validation for each tool
        parameter.  This method is called after internal validation."""
        return

    def execute(self, parameters, messages):
        """The source code of the tool."""
        band_4 = parameters[0].valueAsText
        band_5 = parameters[1].valueAsText
        ndvi_output = parameters[2].valueAsText

        arcpy.gp.RasterCalculator_sa('Float("' + band_5 + '"-"' + band_4 + '") / Float("' + band_5 + '"+"' + band_4 + '")',
        ndvi_output)
        arcpy.AddMessage("NDVI calculations completed!")
        return
